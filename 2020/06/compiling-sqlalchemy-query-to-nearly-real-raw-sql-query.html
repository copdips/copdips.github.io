<!DOCTYPE html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
--><html lang="en" class="no-js">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Compiling SQLAlchemy query to nearly real raw sql query - A code to remember</title>
<meta name="description" content="Compiling SQLAlchemy query to nearly real raw sql query">


  <meta name="author" content="Xiang ZHU">
  
  <meta property="article:author" content="Xiang ZHU">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="A code to remember">
<meta property="og:title" content="Compiling SQLAlchemy query to nearly real raw sql query">
<meta property="og:url" content="https://www.copdips.com/2020/06/compiling-sqlalchemy-query-to-nearly-real-raw-sql-query.html">


  <meta property="og:description" content="Compiling SQLAlchemy query to nearly real raw sql query">







  <meta property="article:published_time" content="2020-06-08T00:00:00+00:00">



  <meta property="article:modified_time" content="2020-06-08T12:35:21+00:00">



  

  


<link rel="canonical" href="https://www.copdips.com/2020/06/compiling-sqlalchemy-query-to-nearly-real-raw-sql-query.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Xiang ZHU",
      "url": "https://www.copdips.com/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="A code to remember Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          A code to remember
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/">Home</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li>
<li class="masthead__menu-item">
              <a href="/year-archive/">Year Archive</a>
            </li>
</ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<!-- back to top button -->
<!-- https://github.com/mmistakes/minimal-mistakes/issues/1731#issuecomment-628997645 -->
<script src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script>addBackToTop({
  diameter: 56,
  backgroundColor: '#F16334',
  textColor: '#fff'
})</script>

<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://www.copdips.com/">
        <img src="/image/avatar/zhuxiang-smile.jpg" alt="Xiang ZHU" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://www.copdips.com/" itemprop="url">Xiang ZHU</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Python DevOps</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Paris</span>
        </li>
      

      
        
          
            <li><a href="https://www.copdips.com" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
          
        
          
        
          
        
          
            <li><a href="https://github.com/copdips" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/xiang-zhu-13769311/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
        
      

      

      
        <li>
          <a href="mailto:xiang.zhu@outlook.com" rel="me" class="u-email">
            <meta itemprop="email" content="xiang.zhu@outlook.com">
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span>
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->

      <!-- 
<script type="text/javascript" src="/assets/js/qrcode/qrcode.min.js"></script>
<div id="qrcode"></div>
<script type="text/javascript">
  var qrcode = new QRCode('qrcode', {width: 10, height: 10, text: location.href});
</script>
 -->
    </ul>
  </div>
</div>
  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Compiling SQLAlchemy query to nearly real raw sql query">
    <meta itemprop="description" content="Compiling SQLAlchemy query to nearly real raw sql query">
    <meta itemprop="datePublished" content="2020-06-08T00:00:00+00:00">
    <meta itemprop="dateModified" content="2020-06-08T12:35:21+00:00">

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://www.copdips.com/2020/06/compiling-sqlalchemy-query-to-nearly-real-raw-sql-query.html" class="u-url" itemprop="url">Compiling SQLAlchemy query to nearly real raw sql query
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2020-06-08T00:00:00+00:00">June 8, 2020</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
<li><a href="#some-useful-links">Some useful links</a></li>
<li><a href="#query-to-compile">Query to compile</a></li>
<li>
<a href="#compiling-to-orm-sql-query">Compiling to ORM sql query</a><ul>
<li><a href="#compiling-filter1-to-orm-sql-query">Compiling filter1 to ORM sql query</a></li>
<li><a href="#compiling-query1-to-orm-sql-query">Compiling query1 to ORM sql query</a></li>
</ul>
</li>
<li>
<a href="#compiling-to-nearly-real-raw-sql-query">Compiling to nearly real raw sql query</a><ul>
<li><a href="#render_query">render_query()</a></li>
<li><a href="#using-the-render_query">Using the render_query()</a></li>
</ul>
</li>
</ul>

            </nav>
          </aside>
        
        <h2 id="some-useful-links">Some useful links</h2>

<ol>
  <li><a href="https://stackoverflow.com/questions/5631078/sqlalchemy-print-the-actual-query">https://stackoverflow.com/questions/5631078/sqlalchemy-print-the-actual-query</a></li>
  <li><a href="https://docs.sqlalchemy.org/en/13/faq/sqlexpressions.html?highlight=literal_bind#rendering-bound-parameters-inline">https://docs.sqlalchemy.org/en/13/faq/sqlexpressions.html?highlight=literal_bind#rendering-bound-parameters-inline</a></li>
  <li><a href="https://docs.sqlalchemy.org/en/13/core/engines.html#configuring-logging">https://docs.sqlalchemy.org/en/13/core/engines.html#configuring-logging</a></li>
</ol>

<h2 id="query-to-compile">Query to compile</h2>

<p>Suppose we have a table called Movie, and a column release_date in the table Movie.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">date</span>

<span class="o">&gt;</span> <span class="kn">from</span> <span class="n">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">sessionmaker</span>

<span class="o">&gt;</span> <span class="n">engine</span> <span class="o">=</span> <span class="nf">create_engine</span><span class="p">(</span><span class="sh">'</span><span class="s">sqlite:///moive_example.db</span><span class="sh">'</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">Session</span> <span class="o">=</span> <span class="nf">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">session</span> <span class="o">=</span> <span class="nc">Session</span><span class="p">()</span>

<span class="o">&gt;</span> <span class="n">filter1</span> <span class="o">=</span> <span class="n">Movie</span><span class="p">.</span><span class="n">release_date</span> <span class="o">&gt;</span> <span class="nf">date</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="o">&gt;</span> <span class="n">filter1</span>
<span class="o">&lt;</span><span class="n">sqlalchemy</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">elements</span><span class="p">.</span><span class="n">BinaryExpression</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x000001FFA56E6BE0</span><span class="o">&gt;</span>

<span class="o">&gt;</span> <span class="nf">str</span><span class="p">(</span><span class="n">filter1</span><span class="p">)</span>
<span class="sh">'</span><span class="s">movies.release_date &gt; :release_date_1</span><span class="sh">'</span>

<span class="o">&gt;</span> <span class="n">query1</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">Movie</span><span class="p">).</span><span class="nf">filter</span><span class="p">(</span><span class="n">Movie</span><span class="p">.</span><span class="n">release_date</span> <span class="o">&gt;</span> <span class="nf">date</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="o">&gt;</span> <span class="n">query1</span>
<span class="o">&lt;</span><span class="n">sqlalchemy</span><span class="p">.</span><span class="n">orm</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">Query</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x0000015A4700A2E0</span><span class="o">&gt;&gt;</span>

<span class="o">&gt;</span> <span class="nf">str</span><span class="p">(</span><span class="n">query1</span><span class="p">)</span>
<span class="sh">'</span><span class="s">SELECT movies.id AS movies_id, movies.title AS movies_title, movies.release_date AS movies_release_date </span><span class="se">\n</span><span class="s">FROM movies </span><span class="se">\n</span><span class="s">WHERE movies.release_date &gt; ?</span><span class="se">\n</span><span class="s"> LIMIT ? OFFSET ?</span><span class="sh">'</span>
</code></pre></div></div>

<h2 id="compiling-to-orm-sql-query">Compiling to ORM sql query</h2>

<p>As per the method given by <a href="https://docs.sqlalchemy.org/en/13/faq/sqlexpressions.html?highlight=literal_bind#rendering-bound-parameters-inline">Rendering Bound Parameters Inline</a>:</p>

<h3 id="compiling-filter1-to-orm-sql-query">Compiling filter1 to ORM sql query</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">filter1</span><span class="p">.</span><span class="nf">compile</span><span class="p">()</span>
<span class="o">&lt;</span><span class="n">sqlalchemy</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">compiler</span><span class="p">.</span><span class="n">StrSQLCompiler</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x000001FFA5706AC0</span><span class="o">&gt;</span>

<span class="o">&gt;</span> <span class="nf">str</span><span class="p">(</span><span class="n">filter1</span><span class="p">.</span><span class="nf">compile</span><span class="p">())</span>
<span class="sh">'</span><span class="s">movies.release_date &gt; :release_date_1</span><span class="sh">'</span>

<span class="o">&gt;</span> <span class="nf">str</span><span class="p">(</span><span class="n">filter1</span><span class="p">.</span><span class="nf">compile</span><span class="p">().</span><span class="n">params</span><span class="p">)</span>
<span class="sh">"</span><span class="s">{</span><span class="sh">'</span><span class="s">release_date_1</span><span class="sh">'</span><span class="s">: datetime.date(2015, 1, 1)}</span><span class="sh">"</span>

<span class="o">&gt;</span> <span class="n">filter1</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">compile_kwargs</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">literal_binds</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
<span class="o">&lt;</span><span class="n">sqlalchemy</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">compiler</span><span class="p">.</span><span class="n">StrSQLCompiler</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x000001FFA572EEE0</span><span class="o">&gt;</span>

<span class="o">&gt;</span> <span class="nf">str</span><span class="p">(</span><span class="n">filter1</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">compile_kwargs</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">literal_binds</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}))</span>
<span class="sh">"</span><span class="s">movies.release_date &gt; </span><span class="sh">'</span><span class="s">2015-01-01</span><span class="sh">'"</span>
</code></pre></div></div>

<h3 id="compiling-query1-to-orm-sql-query">Compiling query1 to ORM sql query</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nf">str</span><span class="p">(</span><span class="n">query1</span><span class="p">.</span><span class="n">statement</span><span class="p">.</span><span class="nf">compile</span><span class="p">())</span>
<span class="sh">'</span><span class="s">SELECT movies.id, movies.title, movies.release_date </span><span class="se">\n</span><span class="s">FROM movies </span><span class="se">\n</span><span class="s">WHERE movies.release_date &gt; :release_date_1</span><span class="se">\n</span><span class="s"> LIMIT :param_1</span><span class="sh">'</span>

<span class="o">&gt;</span> <span class="nf">str</span><span class="p">(</span><span class="n">query1</span><span class="p">.</span><span class="n">statement</span><span class="p">.</span><span class="nf">compile</span><span class="p">().</span><span class="n">params</span><span class="p">)</span>
<span class="sh">"</span><span class="s">{</span><span class="sh">'</span><span class="s">release_date_1</span><span class="sh">'</span><span class="s">: datetime.date(2015, 1, 1), </span><span class="sh">'</span><span class="s">param_1</span><span class="sh">'</span><span class="s">: 2}</span><span class="sh">"</span>

<span class="o">&gt;</span> <span class="nf">str</span><span class="p">(</span><span class="n">query1</span><span class="p">.</span><span class="n">statement</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">compile_kwargs</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">literal_binds</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}))</span>
<span class="sh">"</span><span class="s">SELECT movies.id, movies.title, movies.release_date </span><span class="se">\n</span><span class="s">FROM movies </span><span class="se">\n</span><span class="s">WHERE movies.release_date &gt; </span><span class="sh">'</span><span class="s">2015-01-01</span><span class="sh">'</span><span class="se">\n</span><span class="s"> LIMIT 2</span><span class="sh">"</span>
</code></pre></div></div>

<p class="notice--warning">As given by the paragraph name, the above compiled query is not the real raw sql query sent to the database, it’s an ORM one. But it’s more or less enough for debugging or logging purpose. See below paragraph to get how to compile to real raw sql query.</p>

<h2 id="compiling-to-nearly-real-raw-sql-query">Compiling to nearly real raw sql query</h2>

<p class="notice--warning">SQLAlchemy doesn’t provide an out of the box function to compile a statement to the real raw sql query, and as per some issues’ comments, it seems that the authors wouldn’t like to implement it. There’s no official way, this part is based on some solutions provided by the community.</p>

<p>If you want to compile to real raw sql query, we should add the corresponding dialect, but be aware that it compiles only some simple types like <code class="language-plaintext highlighter-rouge">Integer</code>, <code class="language-plaintext highlighter-rouge">String</code>, etc. For complex types like <code class="language-plaintext highlighter-rouge">Date</code>, we need to <a href="https://stackoverflow.com/a/23835766/5095636">use <code class="language-plaintext highlighter-rouge">TypeDecorator</code> to tell SQLAlchemy how to literal render these complex types</a>. Using <code class="language-plaintext highlighter-rouge">TypeDecorator</code> means to modify your DB models, which is sometimes not a comfortable way.</p>

<p>Below 2 examples (by <a href="https://docs.sqlalchemy.org/en/13/faq/sqlexpressions.html#stringifying-for-specific-databases">using engine or using dialect</a> show the error message on Date type:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># using engine
</span><span class="o">&gt;</span> <span class="nf">str</span><span class="p">(</span><span class="n">filter1</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span>
    <span class="n">engine</span><span class="p">,</span>
    <span class="n">compile_kwargs</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">literal_binds</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
  <span class="p">))</span>
<span class="nb">NotImplementedError</span><span class="p">:</span> <span class="n">Don</span><span class="sh">'</span><span class="s">t know how to literal-quote value datetime.date(2015, 1, 1)
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># using dialect
</span><span class="o">&gt;</span> <span class="kn">from</span> <span class="n">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">postgresql</span>
<span class="o">&gt;</span> <span class="nf">str</span><span class="p">(</span><span class="n">query1</span><span class="p">.</span><span class="n">statement</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span>
    <span class="n">compile_kwargs</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">literal_binds</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
    <span class="n">dialect</span><span class="o">=</span><span class="n">postgresql</span><span class="p">.</span><span class="nf">dialect</span><span class="p">(),</span>
  <span class="p">))</span>
<span class="nb">NotImplementedError</span><span class="p">:</span> <span class="n">Don</span><span class="sh">'</span><span class="s">t know how to literal-quote value datetime.date(2015, 1, 1)
</span></code></pre></div></div>

<h3 id="render_query">render_query()</h3>

<p>Base on this <a href="https://stackoverflow.com/a/32772915/5095636">stackoverflow example</a>, I changed the param dialect to session, and removed the python2 part, hereunder the modified one:</p>

<!--  -->
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="n">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Query</span>

<span class="k">def</span> <span class="nf">render_query</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Generate an SQL expression string with bound parameters rendered inline
    for the given SQLAlchemy statement.
    WARNING: This method of escaping is insecure, incomplete, and for debugging
    purposes only. Executing SQL statements with inline-rendered user values is
    extremely insecure.
    Based on http://stackoverflow.com/questions/5631078/sqlalchemy-print-the-actual-query
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="n">statement</span><span class="p">.</span><span class="n">statement</span>
    <span class="n">dialect</span> <span class="o">=</span> <span class="n">db_session</span><span class="p">.</span><span class="n">bind</span><span class="p">.</span><span class="n">dialect</span>

    <span class="k">class</span> <span class="nc">LiteralCompiler</span><span class="p">(</span><span class="n">dialect</span><span class="p">.</span><span class="n">statement_compiler</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">visit_bindparam</span><span class="p">(</span>
            <span class="n">self</span><span class="p">,</span> <span class="n">bindparam</span><span class="p">,</span> <span class="n">within_columns_clause</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">literal_binds</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">render_literal_value</span><span class="p">(</span><span class="n">bindparam</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">bindparam</span><span class="p">.</span><span class="nb">type</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">render_array_value</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">item_type</span><span class="p">):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
                    <span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="nf">render_array_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">item_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">render_literal_value</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">item_type</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">render_literal_value</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">)):</span>
                <span class="k">return</span> <span class="sh">"'</span><span class="s">{}</span><span class="sh">'"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"'"</span><span class="p">,</span> <span class="sh">"''"</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="sh">"'</span><span class="s">{{{}}}</span><span class="sh">'"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
                    <span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="nf">render_array_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">type_</span><span class="p">.</span><span class="n">item_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="nf">super</span><span class="p">(</span><span class="n">LiteralCompiler</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">render_literal_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>

    <span class="k">return</span> <span class="nc">LiteralCompiler</span><span class="p">(</span><span class="n">dialect</span><span class="p">,</span> <span class="n">statement</span><span class="p">).</span><span class="nf">process</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
</code></pre></div></div>
<!--  -->

<h3 id="using-the-render_query">Using the render_query()</h3>

<p>The results in sqlite dialect:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nf">render_query</span><span class="p">(</span><span class="n">filter1</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
<span class="sh">"</span><span class="s">movies.release_date &gt; </span><span class="sh">'</span><span class="s">2015-01-01</span><span class="sh">'"</span>

<span class="o">&gt;</span> <span class="nf">render_query</span><span class="p">(</span><span class="n">query1</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
<span class="sh">"</span><span class="s">SELECT movies.id, movies.title, movies.release_date </span><span class="se">\n</span><span class="s">FROM movies </span><span class="se">\n</span><span class="s">WHERE movies.release_date &gt; </span><span class="sh">'</span><span class="s">2015-01-01</span><span class="sh">'</span><span class="se">\n</span><span class="s"> LIMIT 2 OFFSET 0</span><span class="sh">"</span>
</code></pre></div></div>

<p class="notice--warning">With <code class="language-plaintext highlighter-rouge">render_query()</code>, it renders the query with dialect syntax, but please be aware that the values rendered are the ones translated by <code class="language-plaintext highlighter-rouge">render_literal_value()</code>, which might not be the ones really passed to SQL database. That’s also why I named this post as <strong>nearly real raw sql query</strong>.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#python" class="page__taxonomy-item p-category" rel="tag">python</a><span class="sep">, </span>
    
      <a href="/tags/#sqlalchemy" class="page__taxonomy-item p-category" rel="tag">sqlalchemy</a>
    
    </span>
  </p>




        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2020-06-08">June 8, 2020</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Compiling+SQLAlchemy+query+to+nearly+real+raw+sql+query%20https%3A%2F%2Fwww.copdips.com%2F2020%2F06%2Fcompiling-sqlalchemy-query-to-nearly-real-raw-sql-query.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.copdips.com%2F2020%2F06%2Fcompiling-sqlalchemy-query-to-nearly-real-raw-sql-query.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.copdips.com%2F2020%2F06%2Fcompiling-sqlalchemy-query-to-nearly-real-raw-sql-query.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>

  <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.copdips.com%2F2020%2F06%2Fcompiling-sqlalchemy-query-to-nearly-real-raw-sql-query.html&title=Compiling%20SQLAlchemy%20query%20to%20nearly%20real%20raw%20sql%20query" class="btn btn--reddit" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i><span> Reddit</span></a>
</section>


      <script type="text/javascript" src="/assets/js/qrcode/qrcode.min.js"></script>
      <div id="qrcode"></div>
      <script type="text/javascript">
        var qrcode = new QRCode('qrcode', {width: 100, height: 100, text: location.href});
      </script>

      
  <nav class="pagination">
    
      <a href="/2020/05/using-python-contextmanager-to-create-a-timer-decorator.html" class="pagination--pager" title="Using Python Contextmanager To Create A Timer Decorator
">Previous</a>
    
    
      <a href="/2020/07/rolling-back-from-flask-restplus-reqparse-to-native-flask-request-to-parse-inputs.html" class="pagination--pager" title="Rolling back from flask-restplus reqparse to native flask request to parse inputs
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a comment</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You may also enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2023/11/github-actions-deploy-static-files-to-azure-web-app.html" rel="permalink">Github actions - deploy static files to azure web app
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-11-18T00:00:00+00:00">November 18, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2023/11/Some-nice-CICD-bash-common-scripts.html" rel="permalink">Some nice cicd bash common scripts
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-11-18T00:00:00+00:00">November 18, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2023/11/github-actions-bash-shell-pipefail.html" rel="permalink">Github Actions - Bash shell -e -o pipefail
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-11-08T00:00:00+00:00">November 8, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2023/10/hashing-files.html" rel="permalink">Hashing files
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-10-21T00:00:00+00:00">October 21, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
<form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div>
</div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
          <li><a href="mailto:xiang.zhu@outlook.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
        
      
        
          <li><a href="https://github.com/copdips" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/xiang-zhu-13769311/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
      
        
      
        
      
        
          <li><a href="https://uptimerobot.com/dashboard#785564645" rel="nofollow noopener noreferrer"><i class="fas fa-clock" aria-hidden="true"></i> Uptime</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">© 2023 Xiang ZHU. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp;
<a href="https://mmistakes.github.io/minimal-mistakes/about/" rel="nofollow">Minimal Mistakes</a>
.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'G-L9KPHRQNQN']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






    
  <script>
    var disqus_config = function () {
      this.page.url = "https://www.copdips.com/2020/06/compiling-sqlalchemy-query-to-nearly-real-raw-sql-query.html";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/2020/06/compiling-sqlalchemy-query-to-nearly-real-raw-sql-query"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://copdips.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>


  





  </body>
</html>
