---
authors:
- copdips
categories:
- azure
- messaging
comments: true
date:
  created: 2024-03-21
---
# Azure Messaging Service

This post is based on the official Azure documentations ([Asynchronous messaging options](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/messaging), [Compare Azure messaging services](https://learn.microsoft.com/en-us/azure/service-bus-messaging/compare-messaging-services#comparison-of-services), [Enterprise integration using message broker and events](https://learn.microsoft.com/en-us/azure/architecture/example-scenario/integration/queues-events), [Azure Well-Architected Framework](https://learn.microsoft.com/en-us/azure/well-architected/)) and describes a resume of differences and uses cases for Azure messaging service, including Service Bus, Event Grid, Event Hubs. The official documentations are very good and comprehensive, this post is for my personal reference as a quick reminder.

<!-- more -->

## Message Types

| Type    | Sub Type                                       | Messaging service | Usage                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Example                                                                                                                                                                                                                                                                                                                                                      |
| ------- | ---------------------------------------------- | ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| command | message                                        | Service Bus       | - The message contains the data that triggered the message pipeline.<br>- A command is a high-value message and must be<br>delivered at least once. If a command is lost, <br>the entire business transaction might fail. <br>- The producer might expect the consumer to <br>acknowledge the message and report the results of the operation.                                                                                                                                                                               | Order processing and financial transactions                                                                                                                                                                                                                                                                                                                  |
| event   | event straming                                 | Event Hub         | - Related events in a sequence, or a stream of events, over a period of time.<br>- Available either as data streams or bundled event batches.<br>- Can [capture the streaming data into a AVRO file for processing and analysis](https://learn.microsoft.com/en-us/azure/event-grid/event-hubs-integration).<br>- Telemetry<br>- Distributed data streaming                                                                                                                                                                  | Event streaming from IoT devices                                                                                                                                                                                                                                                                                                                             |
| event   | Event distribution<br> (discrete notification) | Event Grid        | - Status changes notification.<br>- To announce discrete facts.<br>- The message informs the consumer that an action<br>has taken place without expectations that<br>the event result in any action.<br>- Event Grid isn't a data pipeline, <br>and doesn't deliver the actual object that was updated.<br>- The consumer only needs to know that something happened. <br>- The event data has information about what happened but doesn't <br>have the data that triggered the event.<br> Send emails upon CURD operations. | - Azure Resource Manager raises events<br>when it creates, modifies, or deletes resources. <br>A subscriber of those events could be <br>a Logic App that sends alert emails.<br>Event Grid.<br>- For example, an event notifies consumers that a file was created. <br>It may have general information about the file, but it doesn't have the file itself. |

## Comparison

!!! warning "Below comparison table is not finished"

| Features                                                                                                                                      | [Service Bus](https://learn.microsoft.com/en-us/azure/service-bus-messaging/)                                                                                                                                                                                                                                                                                                                                  | [Event Hub](https://learn.microsoft.com/en-us/azure/event-hubs/) <br>(real-time data streaming platform with native Apache Kafka support)                                                                                                                                                                                                                                                                                                                                                                | [Event Grid](https://learn.microsoft.com/en-us/azure/event-grid/)                                                                                                                                                                                                                                                                  |
| --------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| core components                                                                                                                               | -**queue**: fifo queue, each message has manx one consumer,<br>competing consumer pattern, Load-leveling queue patter, <br>available for all plans<br>- **topic/subscription**: for one-to-many, no queue used, <br>FIFO ordering is not enforced across subscriptions, <br>but maintained inside a subscription by leveraging <br>message session. publish-subscribe pattern, <br>not available in Basic plan | event subscription                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | event subscription                                                                                                                                                                                                                                                                                                                 |
| deliveray policy                                                                                                                              | At least once delivery of an message                                                                                                                                                                                                                                                                                                                                                                           | At least once delivery of an event                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | At least once delivery of an event                                                                                                                                                                                                                                                                                                 |
| ordering (fifo)                                                                                                                               | y                                                                                                                                                                                                                                                                                                                                                                                                              | y<br>by partition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | n                                                                                                                                                                                                                                                                                                                                  |
| pull model                                                                                                                                    | -**polling** by SDK (polling is costy if we dont have many messages)<br>- **pushing** by Azure Functions with Service Bus trigger<br>- **proxied push** with event grid (need service bus in premium tier)                                                                                                                                                                                                     | **pull** <br>- As events are received, <br>Event Hubs appends them to the stream. <br>A subscriber manages its cursor and <br>can move forward and back in the stream, <br>select a time offset, and replay a sequence <br>at its pace.                                                                                                                                                                                                                                                                  | **push** with [event handlers](https://learn.microsoft.com/en-us/azure/event-grid/overview#event-handlers):<br>- Webhooks. Azure Automation runbooks and Logic Apps <br>are supported via webhooks. <br>- Azure functions <br>- Event Hubs <br>- Service Bus queues and topics <br>- Relay hybrid connections <br>- Storage queues |
| reliable (no lost if failed communication)                                                                                                    | y                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                    |
| resilient<br>(new consumer can read message <br>already read by a failed consumer, <br>as long as there's no ACK by the <br>failed consumer') |                                                                                                                                                                                                                                                                                                                                                                                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                    |
| guaranteed delivery<br>(for a message, only one consumer <br>can read)                                                                        | y<br>[Azure Service Bus duplicate message detection](https://learn.microsoft.com/en-us/azure/service-bus-messaging/duplicate-detection)                                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                    |
| duplicate detection                                                                                                                           | y                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                    |
| at least one delivery                                                                                                                         | y                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                    |
| checkpoint                                                                                                                                    | y                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                    |
| dead-letter queue (DLQ)                                                                                                                       | y                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | y                                                                                                                                                                                                                                                                                                                                  |
| retry                                                                                                                                         | y<br>default to 10, max 2000                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | y<br>default to 30 times, and max to 30 times                                                                                                                                                                                                                                                                                      |
| expiration                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | y<br>default to 24 hours, and max to 24 hours                                                                                                                                                                                                                                                                                      |
| filter                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | y<br>filter in a subscription                                                                                                                                                                                                                                                                                                      |
| retention                                                                                                                                     | almost unlimited, functional maximum boundary of the C# Timespan,<br>which corresponds to slightly over 10675199 days.                                                                                                                                                                                                                                                                                         | 7 days                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                                                                                                                                                    |
| partitioning                                                                                                                                  | y<br>For topic/subcription only, not for queue                                                                                                                                                                                                                                                                                                                                                                 | y<br>- For example, several IoT devices send device data <br>to an event hub. The partition key is the device identifier. <br>As events are ingested, Event Hubs moves them to <br>separate partitions. <br>Within each partition, all events are ordered by time.                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                    |
| capture                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                                                | y<br>store the event stream to <br>an [Azure Blob storage](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) or [Data Lake Storage](https://learn.microsoft.com/en-us/azure/storage/blobs/data-lake-storage-introduction).<br>Capture stores *all* events ingested by Event Hubs and <br>is useful for batch processing. <br>You can generate reports on the data by using <br>a MapReduce function. <br>Captured data can also serve as the source of truth.                |                                                                                                                                                                                                                                                                                                                                    |
| support Apache Kafka client                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                | y<br>[Event Hubs for Apache Kafka](https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-for-kafka-ecosystem-overview)kafka broker = event hub namespace<br>kafka topic = event hub                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                    |
| throughput                                                                                                                                    | less than Event Bub                                                                                                                                                                                                                                                                                                                                                                                            | [event-hubs-quotas](https://learn.microsoft.com/en-us/azure/event-hubs/)<br>ingesting millions of events per second.<br>The events are only appended to the stream <br>and are ordered by.<br>Scale in Event Hubs is controlled by <br>how many [throughput units (TUs)](https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-scalability#throughput-units) or [processing units](https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-scalability#processing-units) <br>you purchase. | 10,000,000 events per second per region.<br>The first 100,000 operations per month are free.                                                                                                                                                                                                                                       |
| autoscale                                                                                                                                     | y                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | y                                                                                                                                                                                                                                                                                                                                  |
| disaster recovery                                                                                                                             | y                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | y                                                                                                                                                                                                                                                                                                                                  |
| use cases                                                                                                                                     | financial order                                                                                                                                                                                                                                                                                                                                                                                                | pull data from Event Hubs for the purposes of<br>transformation and statistical analysis. <br>Use[Azure Stream Analytics](https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/data/stream-processing-stream-analytics) and [Apache Spark](https://spark.apache.org/) <br>for complex processing such as aggregation <br>over time windows or anomaly detection.                                                                                                                 | <br>- logs<br>- telemetry<br>- invoke an Azure Function when a blob storage is created or deleted<br>- IoT MQTT                                                                                                                                                                                                                    |
| size                                                                                                                                          | - queue max size: 5GB                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                    |
| cost                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                    |

## Patterns

[Related patterns](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/messaging#related-patterns)

- [Messaging Bridge pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/messaging-bridge)
- [Competing Consumers pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/competing-consumers): Apache Kafka doesn't have this feature.
- [Priority Queue pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/priority-queue)
- [Queue-based Load Leveling pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/queue-based-load-leveling)
- [Retry pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/retry)
- [Scheduler Agent Supervisor pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/scheduler-agent-supervisor)
- [Choreography pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/choreography)
- [Claim-Check pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/claim-check).
